<html>
<head>
<title>ZIP Code search</title>
<script
  src="https://code.jquery.com/jquery-3.1.1.min.js"
  integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
  crossorigin="anonymous"></script>
<style>
.error { color: red }
.main { display: none }

</style>
</head>
<body>
<h1>Zip Code Search</h1>
<div class="loading">Loading...</div>
<div class="main">
	<p>Start typing city name:&nbsp;
	<input id="city" type="text" size="20"></input>
	<select id="states"></select>
	<input type="button" value="Search" onclick="onSearch()"></input>
	</p>
</div>
<div class="error"></div>
<div class="results"></div>
<script>
$(function() {
	
	populateStates()
	.then( ()=> {
		$("#city").focus();
	});
});

function onSearch() {
	clearResults();
	var request = sendSearchRequest();
	request.then( 
		handleSearchResponse, 
		err=>error.show("Error getting list of cities: " + getHttpErrorText(err, request.url)));
}

function clearResults() {
	$(".results").empty();
}

var error = {
	clear: function() { $(".error").text(""); },
	show: function(text) { $(".error").text(text); },
	fatal: function(text) { error.show(text); $(".main").hide(); $(".loading").hide(); }
}

const baseUrl = "http://localhost:8888/v1";

function pageLoaded() {
	$(".loading").hide();
	$(".main").show();
}

function getHttpErrorText(err, url) {
    if (err.readyState === 0) return "Cannot connect to the server at " + url;
	return "The server returned " + err.status + " " + err.statusText + " for " + url;
}

function populateStates() {
	const url = baseUrl + "/states";
	return $.getJSON(url)
		.then(states => {
			const ctrlStates = $("#states");
			
			function addState(state) { 
				ctrlStates.append($("<option></option>")
                    .attr("value",state)
                    .text(state)); 
			}
			
			addState("");
			states.forEach(state=>addState(state));
			pageLoaded();
			
		},
		err => error.fatal("Cannot retrieve the list of states: " + getHttpErrorText(err, url)));
}

function sendSearchRequest() {
	error.clear();
	const city = $("#city").val();
	if (!city) {
		error.show("Please enter fisrt few letters of city name: city name cannot be empty");
		return;
	}
	
	let url = baseUrl + "/search?name=" + encodeURIComponent(city) + "&max=20";
	const state = $("#states").val();
	if (state) url += "&state=" + state;
	
	var request = $.getJSON(url);
	request.url = url;
	return request;
}

function handleSearchResponse(data) {
	if (!data) return;
	var table = $("<table></table>");
	for (let item of data) {
		if (!item.records) continue;
		var tdName = $("<td></td>");
		tdName.text(item.name);
		
		var tdZip = $("<td></td>");
		tdZip.text(item.records.map(r=>r.zip).join(","));
		
		var tr = $("<tr></tr>");
		tr.append(tdName);
		tr.append(tdZip);
		table.append(tr);
	}
	$(".results").append(table);
}
</script>
</body>
</html>